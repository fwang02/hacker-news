{% load socialaccount %}
{% load static %}
{% load custom_filters %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ submission.title }}</title>
    <link rel="stylesheet" href="{% static 'news/styles.css' %}">
</head>
<body>
    <!-- Header Section -->
    {% include "header.html" %}

    <div class="submission-detail">
        <!-- Submission Header -->
        <div class="submission-header">
            <li class="news-item">
                <div class="icon-container">
                    {% if submission.author == request.user %}
                        <span class="red-asterisk">*</span>
                        <span class="triangle-icon hidden "></span>
                    {% else %}
                        <span class="triangle-icon"></span>
                    {% endif %}
                </div>
                <span class="news-title">
                    <a href="{{ submission.url }}">{{ submission.title }}</a>
                    <small>({{ submission.url|domain }})</small>
                </span>
                <span class="news-details">
                    X points
                    by <a href="{% url 'users:profile' %}?id={{ submission.author }}" class="submissions-link">{{ submission.author }}</a>
                    | <a href="{% url 'news:hide_submission' submission.id %}" class="submissions-link">hide</a>
                    |<a href="{% url 'news:submission_detail' submission.id %}" class="submissions-link">
                        {% if submission.comment_count == 1 %}
                            1 comment
                        {% else %}
                            {{ submission.comment_count }} comments
                        {% endif %}
                    </a>
                    {% if submission.author == request.user %}
                        | <a href="{% url 'news:delete_submission' submission.id %}" class="submissions-link" onclick="confirmDelete(event)">delete</a>
                    {% endif %}
                </span>
            </li>
        </div>

        <!-- Add Comment Form -->
        <div class="add-comment">
            <form method="POST">
                {% csrf_token %}
                {{ form.text }}
                <button type="submit">add comment</button>
            </form>
        </div>

        <!-- Comments Section -->
        <div id="comments">
            {% for comment in comments %}
                <div class="comment" id="comment-{{ comment.id }}">
                    <p class="comment-meta">
                        {% if comment.author == request.user %}
                                <span class="red-asterisk-comments">*</span>
                                <span class="triangle-icon hidden "></span>
                            {% else %}
                                <span class="triangle-icon"></span>
                            {% endif %}
                        <strong>{{ comment.author.username }}</strong> 
                        <span class="comment-time">{{ comment.created_at }}</span>
                        
                        {% if comment.author == request.user %}
                            | <a href="{% url 'news:confirm_delete' comment.id %}" class="comment-link" onclick="confirmDelete(event)">delete</a>
                        {% endif %}
                        <a href="javascript:void(0);" class="toggle-comment">[-]</a>
                    </p>
                    <div class="comment-content">
                        <p class="comment-text">{{ comment.text }}</p>
                        <a href="#reply" class="reply-link">reply</a>
                    </div>
                </div>
            {% empty %}
                <p>No comments yet.</p>
            {% endfor %}
        </div>

        <!-- Link to go back to the news page -->
        <div class="back-link">
            <a href="{% url 'news:news' %}">Back to News</a>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Delete comment functionality
            const deleteLinks = document.querySelectorAll('.delete-comment');

            deleteLinks.forEach(function(link) {
                link.addEventListener('click', function(event) {
                    event.preventDefault();

                    const commentId = this.getAttribute('data-comment-id');
                    const url = `/delete_comment/${commentId}/`;  // URL para eliminar el comentario

                    fetch(url, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': document.querySelector('[name="csrfmiddlewaretoken"]').value
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Eliminar el comentario del DOM
                            const commentDiv = document.getElementById(`comment-${commentId}`);
                            commentDiv.remove();
                        } else {
                            alert('Error al eliminar el comentario.');
                        }
                    })
                    .catch(error => console.error('Error:', error));
                });
            });

            // Toggle comment visibility (expand/collapse)
            const toggleLinks = document.querySelectorAll('.toggle-comment');
            toggleLinks.forEach(function(link) {
                link.addEventListener('click', function(event) {
                    event.preventDefault();

                    const commentContent = this.closest('.comment').querySelector('.comment-content');
                    if (commentContent.style.display === "none") {
                        commentContent.style.display = "block";
                        this.textContent = "[-]";  // Cambio de texto para indicar que puede ocultarse
                    } else {
                        commentContent.style.display = "none";
                        this.textContent = "[+]";  // Cambio de texto para indicar que puede expandirse
                    }
                });
            });
        });
    </script>
</body>
</html>